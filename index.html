<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BJ Toilet Finder</title>

    <script type="text/javascript">
        window._AMapSecurityConfig = { securityJsCode: '5ffadc3176970e5963d9961ada9fc1e3' };
    </script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#51A1B4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=27cb9ef31045cd08c4eae5263589ccc4"></script>
    
    <style>
        /* 强制覆盖：确保 HTML 和 Body 具有物理尺寸 */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #ffffff; }
        
        /* 地图容器：最高渲染优先级 */
        #map { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; display: block; }

        /* 顶部栏 */
        .top-bar {
            position: fixed; top: env(safe-area-inset-top, 12px); left: 50%; transform: translateX(-50%);
            width: 88%; max-width: 380px; background: rgba(255,255,255,0.95); padding: 8px 16px;
            border-radius: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .lang-text { font-size: 13px; font-weight: 700; color: #1d1d1f; }
        select { border: none; background: #f0f0f0; padding: 6px 12px; border-radius: 12px; font-size: 11px; color: #51A1B4; font-weight: 600; outline: none; }

        /* 底部按钮 */
        .action-btn {
            position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
            width: 52px; height: 52px; background: #fff; border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 100;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-refresh { left: 20px; }
        .btn-locate { right: 20px; }

        /* 弹窗样式 */
        .pop { min-width: 160px; padding: 4px 0; font-family: sans-serif; }
        .pop h4 { margin: 0 0 6px; font-size: 14px; }
        .stats { font-size: 12px; color: #51A1B4; font-weight: 700; margin-bottom: 8px; }
        .nav-link { display: block; padding: 10px; background: #000; color: #fff; text-align: center; text-decoration: none; border-radius: 8px; font-size: 12px; font-weight: 700; }
        
        /* 隐藏无用 UI */
        .amap-copyright, .amap-mclogo { visibility: hidden !important; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="lang-text" id="curLangName">English</div>
    <select id="langSelect">
        <option value="en">Change Language</option>
        <option value="ko">한국어</option>
        <option value="ja">日本語</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
    </select>
</div>

<div class="action-btn btn-refresh" onclick="location.reload(true)">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="#FF3B30"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</div>

<div class="action-btn btn-locate" id="reLocate">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="#007AFF"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.1z"/></svg>
</div>

<div id="map"></div>

<script>
    const i18n = {
        en:{n:"English",g:"Navigate"}, ko:{n:"한국어",g:"네비게이션"},
        ja:{n:"日本語",g:"ナビ"}, es:{n:"Español",g:"Navegar"}, fr:{n:"Français",g:"Naviguer"}
    };

    let curL='en', map, ps, geo, walker, userPos=null, userM, routeL, timer;

    const wcIcon = `
        <div style="filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">
            <svg width="34" height="42" viewBox="0 0 34 42" fill="none">
                <path d="M17 0C7.6 0 0 7.6 0 17C0 27.2 17 42 17 42C17 42 34 27.2 34 17C34 7.6 26.4 0 17 0Z" fill="#51A1B4"/>
                <circle cx="17" cy="17" r="11" fill="white"/>
                <text x="17" y="21" font-family="Arial" font-size="9" font-weight="900" fill="#51A1B4" text-anchor="middle">WC</text>
            </svg>
        </div>
    `;

    // 核心修复：确保 DOM 已经完全计算完高度后再初始化地图
    function initApp() {
        // 显式加载插件，避免 URL 参数失效
        AMap.plugin(['AMap.PlaceSearch', 'AMap.Geolocation', 'AMap.Walking'], function() {
            
            map = new AMap.Map('map', { 
                zoom: 15, 
                center: [116.397, 39.909], // 初始天安门，确保底图能出来
                viewMode: '2D'
            });

            map.on('complete', () => {
                ps = new AMap.PlaceSearch({ type: '公共厕所', pageSize: 40 });
                walker = new AMap.Walking();
                
                geo = new AMap.Geolocation({ enableHighAccuracy: true, timeout: 8000 });
                
                // 首次定位
                geo.getCurrentPosition((status, result) => {
                    if(status === 'complete') {
                        userPos = result.position;
                        updateUserMarker(result.position);
                        map.setZoomAndCenter(16, result.position);
                    }
                    searchToilets();
                });

                // 持续监听
                geo.watchPosition();
                AMap.event.addListener(geo, 'complete', data => {
                    userPos = data.position;
                    updateUserMarker(data.position);
                });
            });

            map.on('moveend', () => { clearTimeout(timer); timer = setTimeout(searchToilets, 300); });
        });
    }

    function updateUserMarker(pos) {
        const svg = `<svg viewBox="0 0 496 512" width="40" height="40" fill="#F4A000" stroke="white" stroke-width="15"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg>`;
        if (userM) userM.setPosition(pos);
        else userM = new AMap.Marker({ 
            position: pos, 
            content: `<div style="animation: bounce 2s infinite;">${svg}</div>`, 
            offset: new AMap.Pixel(-20, -40), 
            map: map 
        });
    }

    function searchToilets() {
        if(!ps || !map) return;
        ps.searchNearBy('', map.getCenter(), 1500, (status, result) => {
            map.getAllOverlays('marker').forEach(m => { if(m !== userM) map.remove(m); });
            if(status === 'complete' && result.poiList) {
                result.poiList.pois.forEach(p => {
                    const m = new AMap.Marker({
                        position: p.location,
                        content: wcIcon,
                        offset: new AMap.Pixel(-17, -42),
                        map: map
                    });
                    m.on('click', () => {
                        if(routeL) map.remove(routeL);
                        if(userPos) walker.search(userPos, p.location, (st, res) => {
                            let dist="...", time="...";
                            if(st === 'complete') {
                                routeL = new AMap.Polyline({ 
                                    path: res.routes[0].steps.flatMap(s => s.path), 
                                    strokeColor: "#51A1B4", strokeWeight: 6, map: map 
                                });
                                dist = res.routes[0].distance + "m";
                                time = Math.round(res.routes[0].time/60) + "min";
                            }
                            const content = `
                                <div class="pop">
                                    <h4>${p.name}</h4>
                                    <div class="stats">${time} • ${dist}</div>
                                    <a href="http://maps.apple.com/?daddr=${p.location.lat},${p.location.lng}&dirflg=w" class="nav-link">${i18n[curL].g}</a>
                                </div>`;
                            new AMap.InfoWindow({ content, offset: new AMap.Pixel(0, -35) }).open(map, p.location);
                        });
                    });
                });
            }
        });
    }

    document.getElementById('langSelect').onchange = e => { 
        curL = e.target.value; 
        document.getElementById('curLangName').innerText = i18n[curL].n; 
        searchToilets(); 
    };
    document.getElementById('reLocate').onclick = () => { 
        if(geo) geo.getCurrentPosition((s, r) => { if(s==='complete') { map.setCenter(r.position); searchToilets(); } }); 
    };

    // 关键：延时 100 毫秒启动，确保 body 渲染完毕
    window.addEventListener('load', () => {
        setTimeout(initApp, 100);
    });
</script>
</body>
</html>
