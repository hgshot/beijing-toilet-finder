<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Beijing Toilet Finder</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#51A1B4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BJ Toilet Finder">
    <link rel="apple-touch-icon" href="icon.png">

    <script type="text/javascript">
        window._AMapSecurityConfig = { securityJsCode: '5ffadc3176970e5963d9961ada9fc1e3' };
    </script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=27cb9ef31045cd08c4eae5263589ccc4&plugin=AMap.PlaceSearch,AMap.Geolocation,AMap.Walking"></script>
    
    <style>
        /* å…¨å±€å˜é‡è°ƒæ•´ */
        :root { 
            --p: #51A1B4; 
            /* å…³é”®ä¿®æ”¹ï¼šé€æ˜åº¦ä» 0.9 é™è‡³ 0.6ï¼Œå¤§å¹…å¢å¼ºé€å…‰æ„Ÿ */
            --g: rgba(255, 255, 255, 0.60); 
            --s: 0 4px 16px rgba(0,0,0,0.12); 
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, sans-serif; background: #fff; }
        
        /* å¼ºåˆ¶åœ°å›¾å®¹å™¨ç‰©ç†å°ºå¯¸ */
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; width: 100% !important; height: 100% !important; z-index: 1; display: block; }

        /* é¡¶éƒ¨æ  */
        .top-bar {
            position: absolute; top: env(safe-area-inset-top, 12px); left: 50%; transform: translateX(-50%);
            width: 88%; max-width: 380px; 
            /* ç£¨ç ‚æ•ˆæœ */
            background: var(--g); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 24px; box-shadow: var(--s); z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .lang-info { font-size: 13px; font-weight: 700; color: #1d1d1f; }
        /* ä¸‹æ‹‰æ¡†ä¹Ÿè·Ÿéšå˜å¾—æ›´é€æ˜ */
        select { border: none; background: rgba(255, 255, 255, 0.4); padding: 6px 12px; border-radius: 12px; font-size: 12px; color: var(--p); font-weight: 600; outline: none; }

        /* åº•éƒ¨æ“ä½œæŒ‰é’® */
        .btn-ui {
            position: absolute; bottom: calc(env(safe-area-inset-bottom, 20px) + 10px);
            width: 54px; height: 54px; 
            background: var(--g); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 18px; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--s); z-index: 100; cursor: pointer;
        }
        .btn-refresh { left: 20px; }
        .btn-re { right: 20px; }

        /* å¤§å·åŠé€æ˜å¼•å¯¼æ°”æ³¡ */
        .install-toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            width: 75%; max-width: 400px; padding: 25px 20px; 
            
            /* æ°”æ³¡ä¿æŒè¾ƒæ·±èƒŒæ™¯ä»¥ä¿è¯æ–‡å­—å¯è¯»æ€§ï¼Œä½†ä¹Ÿå¢åŠ äº†ç£¨ç ‚æ„Ÿ */
            background: rgba(0, 0, 0, 0.60); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            
            display: flex; justify-content: center; align-items: center;
            color: #fff; text-align: center;
            border-radius: 50px; font-size: 15px; font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25); z-index: 200;
            opacity: 0; pointer-events: none; transition: opacity 0.6s ease;
        }
        .install-toast.show { opacity: 1; }

        .pop { min-width: 170px; padding: 4px 0; }
        .stats { font-size: 13px; color: var(--p); font-weight: 700; margin: 4px 0 8px; }
        .ext-btn { display: block; padding: 10px; border-radius: 8px; text-decoration: none; color: #fff; font-size: 12px; font-weight: 700; text-align: center; margin-bottom: 6px; }
        
        .amap-copyright, .amap-mclogo { display: none !important; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
        .wc-marker { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="lang-info" id="curL">English</div>
    <select id="lS">
        <option value="en">Change Language</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="es">EspaÃ±ol</option>
        <option value="fr">FranÃ§ais</option>
    </select>
</div>

<div id="iTip" class="install-toast">Add to Home Screen for easy access ğŸ“±</div>

<div class="btn-ui btn-refresh" onclick="location.reload()">
    <svg viewBox="0 0 24 24" width="26" height="26" fill="#FF3B30"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
</div>

<div class="btn-ui btn-re" id="re">
    <svg viewBox="0 0 24 24" width="26" height="26" fill="#007AFF"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
</div>

<div id="map"></div>

<script>
    // æ›´æ–°äº† Toast æç¤ºè¯­ (På­—æ®µ)
    const i18n = {
        en:{n:"English",t:"Toilet",g:"Open App", p:"Add to Home Screen for easy access ğŸ“±"}, 
        ko:{n:"í•œêµ­ì–´",t:"í™”ì¥ì‹¤",g:"ì•± ì—´ê¸°", p:"ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê¸° ì‰½ë„ë¡ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì„¸ìš” ğŸ“±"},
        ja:{n:"æ—¥æœ¬èª",t:"ãƒˆã‚¤ãƒ¬",g:"ã‚¢ãƒ—ãƒª", p:"ä¾¿åˆ©ãªä½¿ã„æ–¹ï¼šãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ  ğŸ“±"}, 
        zh:{n:"ä¸­æ–‡",t:"å•æ‰€",g:"æ‰“å¼€åº”ç”¨", p:"è¯·å°†ä¹¦ç­¾æ·»åŠ åˆ°æ¡Œé¢æ–¹ä¾¿åç»­ä½¿ç”¨ ğŸ“±"},
        es:{n:"EspaÃ±ol",t:"BaÃ±o",g:"Abrir", p:"AÃ±adir a pantalla de inicio para acceso fÃ¡cil ğŸ“±"}, 
        fr:{n:"FranÃ§ais",t:"Toilettes",g:"Ouvrir", p:"Ajouter Ã  l'Ã©cran d'accueil pour un accÃ¨s facile ğŸ“±"}
    };

    let curL='en', map, ps, geo, walker, userPos=null, userM, routeL, timer;

    const wcIconContent = `
        <div class="wc-marker">
            <svg width="34" height="42" viewBox="0 0 34 42" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 0C7.61116 0 0 7.61116 0 17C0 27.2 17 42 17 42C17 42 34 27.2 34 17C34 7.61116 26.3888 0 17 0Z" fill="#51A1B4"/>
                <circle cx="17" cy="17" r="11" fill="white"/>
                <text x="17" y="21" font-family="Arial" font-size="9" font-weight="bold" fill="#51A1B4" text-anchor="middle">WC</text>
            </svg>
        </div>
    `;

    // æ™ºèƒ½å¼•å¯¼æ£€æµ‹é€»è¾‘
    const checkInstallPrompt = () => {
        if (window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) return;
        const lastPrompt = localStorage.getItem('bj_install_prompt_time');
        const now = Date.now();
        const interval = 90 * 24 * 60 * 60 * 1000; 
        if (!lastPrompt || (now - lastPrompt > interval)) {
            const tip = document.getElementById('iTip');
            // è‡ªåŠ¨æ£€æµ‹æ˜¯å¦ä¸ºä¸­æ–‡ç¯å¢ƒï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥æ˜¾ç¤ºä¸­æ–‡ï¼Œå¦åˆ™æ˜¾ç¤ºå½“å‰è¯­è¨€
            // è¿™é‡Œæˆ‘ä»¬ç®€åŒ–é€»è¾‘ï¼Œè·Ÿéšå³ä¸Šè§’è¯­è¨€é€‰æ‹©ï¼Œæˆ–è€…é»˜è®¤å°è¯•åŒ¹é…ä¸­æ–‡
            if (curL === 'en' && navigator.language.startsWith('zh')) {
                 // é»˜è®¤æƒ…å†µå¦‚æœç³»ç»Ÿæ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨ä¸­æ–‡æç¤º
                 tip.innerText = i18n['zh'].p;
            } else {
                 tip.innerText = i18n[curL] ? i18n[curL].p : i18n['zh'].p;
            }

            setTimeout(() => {
                tip.classList.add('show');
                localStorage.setItem('bj_install_prompt_time', now);
                setTimeout(() => { tip.classList.remove('show'); }, 5000);
            }, 1000);
        }
    };

    const initMap = () => {
        try {
            map = new AMap.Map('map', { zoom: 15, center: [116.397, 39.909], viewMode: '2D' });
            map.on('complete', () => {
                checkInstallPrompt();
                ps = new AMap.PlaceSearch({ type: 'å…¬å…±å•æ‰€', pageSize: 40 });
                walker = new AMap.Walking();
                geo = new AMap.Geolocation({ enableHighAccuracy: true, timeout: 10000 });
                geo.getCurrentPosition((s, r) => {
                    if(s==='complete') {
                        userPos = r.position;
                        updateUM(r.position);
                        map.setZoomAndCenter(16, r.position);
                    }
                    search();
                });
            });
            map.on('moveend', () => { clearTimeout(timer); timer = setTimeout(search, 300); });
        } catch (e) { console.error(e); }
    };

    const updateUM = (pos) => {
        const svgUser = `<svg viewBox="0 0 496 512" width="40" height="40" fill="#F4A000" stroke="white" stroke-width="15"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg>`;
        if (userM) userM.setPosition(pos);
        else userM = new AMap.Marker({ position: pos, content: `<div style="animation: bounce 2s infinite;">${svgUser}</div>`, offset: new AMap.Pixel(-20, -40), map: map });
    };

    const search = () => {
        if(!ps || !map) return;
        ps.searchNearBy('', map.getCenter(), 1500, (s, r) => {
            map.getAllOverlays('marker').forEach(m => { if(m !== userM) map.remove(m); });
            if(s==='complete' && r.poiList) {
                r.poiList.pois.forEach(p => {
                    const m = new AMap.Marker({ position: p.location, content: wcIconContent, offset: new AMap.Pixel(-17, -42), map: map });
                    m.on('click', () => {
                        if(routeL) map.remove(routeL);
                        if(userPos) walker.search(userPos, p.location, (status, res) => {
                            let t="...", d="...";
                            if(status==='complete') {
                                routeL = new AMap.Polyline({ path: res.routes[0].steps.flatMap(s => s.path), strokeColor: "#007AFF", strokeOpacity: 0.8, strokeWeight: 6, map: map });
                                t = Math.round(res.routes[0].time/60) + " min";
                                d = res.routes[0].distance + " m";
                            }
                            const content = `<div class="pop"><h4>${p.name}</h4><div class="stats">${t} â€¢ ${d}</div><details><summary>${i18n[curL].g}</summary><a href="http://maps.apple.com/?daddr=${p.location.lat},${p.location.lng}&dirflg=w" class="ext-btn" style="background:#000">Apple Maps</a><a href="https://www.google.com/maps/dir/?api=1&destination=${p.location.lat},${p.location.lng}&travelmode=walking" class="ext-btn" style="background:#34A853">Google Maps</a></details></div>`;
                            new AMap.InfoWindow({ content, offset: new AMap.Pixel(0, -35) }).open(map, p.location);
                        });
                    });
                });
            }
        });
    };

    document.getElementById('lS').onchange = e => { curL = e.target.value; document.getElementById('curL').innerText = i18n[curL].n; search(); };
    document.getElementById('re').onclick = () => { if(geo) geo.getCurrentPosition((s, r) => { if(s==='complete') { map.setCenter(r.position); search(); } }); };

    window.onload = initMap;
</script>
</body>
</html>
